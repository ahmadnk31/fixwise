module.exports = [
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/shared/lib/no-fallback-error.external.js [external] (next/dist/shared/lib/no-fallback-error.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/shared/lib/no-fallback-error.external.js", () => require("next/dist/shared/lib/no-fallback-error.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}),
"[project]/lib/supabase/server.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "createClient",
    ()=>createClient,
    "createServerClient",
    ()=>createServerClient
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$supabase$2b$ssr$40$0$2e$7$2e$0_$40$supabase$2b$supabase$2d$js$40$2$2e$81$2e$1$2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/@supabase+ssr@0.7.0_@supabase+supabase-js@2.81.1/node_modules/@supabase/ssr/dist/module/index.js [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$supabase$2b$ssr$40$0$2e$7$2e$0_$40$supabase$2b$supabase$2d$js$40$2$2e$81$2e$1$2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$createServerClient$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/@supabase+ssr@0.7.0_@supabase+supabase-js@2.81.1/node_modules/@supabase/ssr/dist/module/createServerClient.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$0_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$headers$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/next@16.0.0_@opentelemetry+api@1.9.0_react-dom@19.2.0_react@19.2.0__react@19.2.0/node_modules/next/headers.js [app-route] (ecmascript)");
;
;
async function createServerClient() {
    const cookieStore = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$0_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$headers$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["cookies"])();
    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$supabase$2b$ssr$40$0$2e$7$2e$0_$40$supabase$2b$supabase$2d$js$40$2$2e$81$2e$1$2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$createServerClient$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServerClient"])(("TURBOPACK compile-time value", "https://ejtvkywefkrxbkubhmfg.supabase.co"), ("TURBOPACK compile-time value", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqdHZreXdlZmtyeGJrdWJobWZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExOTEwMzUsImV4cCI6MjA3Njc2NzAzNX0.9yxYR8w-OSxpkovZU6tgFO74HfYb43O-dWTlgoXvew4"), {
        cookies: {
            getAll () {
                return cookieStore.getAll();
            },
            setAll (cookiesToSet) {
                try {
                    cookiesToSet.forEach(({ name, value, options })=>cookieStore.set(name, value, options));
                } catch  {
                // The "setAll" method was called from a Server Component.
                // This can be ignored if you have middleware refreshing
                // user sessions.
                }
            }
        }
    });
}
const createClient = createServerClient;
}),
"[externals]/node:crypto [external] (node:crypto, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:crypto", () => require("node:crypto"));

module.exports = mod;
}),
"[project]/lib/email.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "sendBookingConfirmationEmail",
    ()=>sendBookingConfirmationEmail,
    "sendBookingStatusUpdateEmail",
    ()=>sendBookingStatusUpdateEmail
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$resend$40$6$2e$4$2e$2$2f$node_modules$2f$resend$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/resend@6.4.2/node_modules/resend/dist/index.mjs [app-route] (ecmascript)");
;
const resend = new __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$resend$40$6$2e$4$2e$2$2f$node_modules$2f$resend$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Resend"](process.env.RESEND_API_KEY);
async function sendBookingConfirmationEmail(data) {
    if (!process.env.RESEND_API_KEY) {
        console.warn("RESEND_API_KEY not configured, skipping email");
        return;
    }
    const fromEmail = process.env.RESEND_FROM_EMAIL || "noreply@fixwise.com";
    const formattedDate = new Date(data.appointmentDate).toLocaleDateString("en-US", {
        weekday: "long",
        year: "numeric",
        month: "long",
        day: "numeric"
    });
    try {
        await resend.emails.send({
            from: fromEmail,
            to: data.userEmail,
            subject: `Booking ${data.status === "confirmed" ? "Confirmed" : "Received"} - ${data.shopName}`,
            html: `
        <!DOCTYPE html>
        <html>
          <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Booking ${data.status === "confirmed" ? "Confirmed" : "Received"}</title>
          </head>
          <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;">
            <div style="background: linear-gradient(135deg, #1A2332 0%, #2D3748 100%); padding: 30px; text-align: center; border-radius: 10px 10px 0 0;">
              <h1 style="color: #fff; margin: 0;">FixWise</h1>
            </div>
            
            <div style="background: #f9fafb; padding: 30px; border-radius: 0 0 10px 10px; border: 1px solid #e5e7eb;">
              <h2 style="color: #1A2332; margin-top: 0;">
                ${data.status === "confirmed" ? "‚úÖ Booking Confirmed!" : "üìÖ Booking Received"}
              </h2>
              
              <p>Hello ${data.userName},</p>
              
              <p>
                ${data.status === "confirmed" ? "Great news! Your booking has been confirmed by the repair shop." : "Your booking request has been received and is pending confirmation from the repair shop."}
              </p>
              
              <div style="background: #fff; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #1A2332;">
                <h3 style="margin-top: 0; color: #1A2332;">Booking Details</h3>
                <p><strong>Shop:</strong> ${data.shopName}</p>
                <p><strong>Date:</strong> ${formattedDate}</p>
                <p><strong>Time:</strong> ${data.appointmentTime}</p>
                ${data.shopAddress ? `<p><strong>Address:</strong> ${data.shopAddress}</p>` : ""}
                ${data.shopPhone ? `<p><strong>Phone:</strong> ${data.shopPhone}</p>` : ""}
                ${data.notes ? `<p><strong>Notes:</strong> ${data.notes}</p>` : ""}
                <p><strong>Status:</strong> <span style="text-transform: capitalize; font-weight: bold; color: ${data.status === "confirmed" ? "#10b981" : data.status === "completed" ? "#3b82f6" : data.status === "cancelled" ? "#ef4444" : "#f59e0b"};">${data.status}</span></p>
              </div>
              
              ${data.status === "pending" ? `
                <p style="color: #6b7280; font-size: 14px;">
                  You will receive another email once the shop confirms your booking.
                </p>
              ` : ""}
              
              ${data.status === "confirmed" ? `
                <p style="color: #059669; font-weight: bold;">
                  Please arrive on time for your appointment. If you need to reschedule or cancel, please contact the shop directly.
                </p>
              ` : ""}
              
              <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e5e7eb; text-align: center; color: #6b7280; font-size: 12px;">
                <p>This is an automated email from FixWise. Please do not reply to this email.</p>
                <p>If you have questions, please contact ${data.shopEmail || "the repair shop"} directly.</p>
              </div>
            </div>
          </body>
        </html>
      `
        });
        // Also send notification to shop owner if email is available
        if (data.shopEmail && data.status === "pending") {
            await resend.emails.send({
                from: fromEmail,
                to: data.shopEmail,
                subject: `New Booking Request - ${data.userName}`,
                html: `
          <!DOCTYPE html>
          <html>
            <head>
              <meta charset="utf-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>New Booking Request</title>
            </head>
            <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;">
              <div style="background: linear-gradient(135deg, #1A2332 0%, #2D3748 100%); padding: 30px; text-align: center; border-radius: 10px 10px 0 0;">
                <h1 style="color: #fff; margin: 0;">FixWise</h1>
              </div>
              
              <div style="background: #f9fafb; padding: 30px; border-radius: 0 0 10px 10px; border: 1px solid #e5e7eb;">
                <h2 style="color: #1A2332; margin-top: 0;">üìÖ New Booking Request</h2>
                
                <p>Hello,</p>
                
                <p>You have received a new booking request for <strong>${data.shopName}</strong>.</p>
                
                <div style="background: #fff; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #1A2332;">
                  <h3 style="margin-top: 0; color: #1A2332;">Booking Details</h3>
                  <p><strong>Customer:</strong> ${data.userName}</p>
                  <p><strong>Email:</strong> ${data.userEmail}</p>
                  <p><strong>Date:</strong> ${formattedDate}</p>
                  <p><strong>Time:</strong> ${data.appointmentTime}</p>
                  ${data.notes ? `<p><strong>Notes:</strong> ${data.notes}</p>` : ""}
                  <p><strong>Status:</strong> <span style="text-transform: capitalize; font-weight: bold; color: #f59e0b;">Pending</span></p>
                </div>
                
                <p style="color: #059669; font-weight: bold;">
                  Please log in to your dashboard to confirm or manage this booking.
                </p>
                
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e5e7eb; text-align: center; color: #6b7280; font-size: 12px;">
                  <p>This is an automated email from FixWise.</p>
                </div>
              </div>
            </body>
          </html>
        `
            });
        }
    } catch (error) {
        console.error("Error sending booking email:", error);
    // Don't throw - email failures shouldn't break the booking process
    }
}
async function sendBookingStatusUpdateEmail(data) {
    if (!process.env.RESEND_API_KEY) {
        console.warn("RESEND_API_KEY not configured, skipping email");
        return;
    }
    const fromEmail = process.env.RESEND_FROM_EMAIL || "noreply@fixwise.com";
    const formattedDate = new Date(data.appointmentDate).toLocaleDateString("en-US", {
        weekday: "long",
        year: "numeric",
        month: "long",
        day: "numeric"
    });
    const statusMessages = {
        confirmed: {
            subject: "Booking Confirmed",
            message: "Great news! Your booking has been confirmed.",
            color: "#10b981"
        },
        cancelled: {
            subject: "Booking Cancelled",
            message: "Your booking has been cancelled.",
            color: "#ef4444"
        },
        completed: {
            subject: "Booking Completed",
            message: "Your booking has been marked as completed.",
            color: "#3b82f6"
        }
    };
    const statusInfo = statusMessages[data.status] || {
        subject: "Booking Status Updated",
        message: "Your booking status has been updated.",
        color: "#6b7280"
    };
    try {
        await resend.emails.send({
            from: fromEmail,
            to: data.userEmail,
            subject: `${statusInfo.subject} - ${data.shopName}`,
            html: `
        <!DOCTYPE html>
        <html>
          <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>${statusInfo.subject}</title>
          </head>
          <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;">
            <div style="background: linear-gradient(135deg, #1A2332 0%, #2D3748 100%); padding: 30px; text-align: center; border-radius: 10px 10px 0 0;">
              <h1 style="color: #fff; margin: 0;">FixWise</h1>
            </div>
            
            <div style="background: #f9fafb; padding: 30px; border-radius: 0 0 10px 10px; border: 1px solid #e5e7eb;">
              <h2 style="color: #1A2332; margin-top: 0;">
                ${data.status === "confirmed" ? "‚úÖ Booking Confirmed!" : data.status === "cancelled" ? "‚ùå Booking Cancelled" : "‚úÖ Booking Completed"}
              </h2>
              
              <p>Hello ${data.userName},</p>
              
              <p>${statusInfo.message}</p>
              
              <div style="background: #fff; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid ${statusInfo.color};">
                <h3 style="margin-top: 0; color: #1A2332;">Booking Details</h3>
                <p><strong>Shop:</strong> ${data.shopName}</p>
                <p><strong>Date:</strong> ${formattedDate}</p>
                <p><strong>Time:</strong> ${data.appointmentTime}</p>
                <p><strong>Status:</strong> <span style="text-transform: capitalize; font-weight: bold; color: ${statusInfo.color};">${data.status}</span></p>
              </div>
              
              ${data.status === "confirmed" ? `
                <p style="color: #059669; font-weight: bold;">
                  Please arrive on time for your appointment. If you need to reschedule or cancel, please contact the shop directly.
                </p>
              ` : data.status === "cancelled" ? `
                <p style="color: #6b7280;">
                  If you need to book a new appointment, please visit our website or contact the shop directly.
                </p>
              ` : ""}
              
              <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e5e7eb; text-align: center; color: #6b7280; font-size: 12px;">
                <p>This is an automated email from FixWise. Please do not reply to this email.</p>
                <p>If you have questions, please contact ${data.shopEmail || "the repair shop"} directly.</p>
              </div>
            </div>
          </body>
        </html>
      `
        });
    } catch (error) {
        console.error("Error sending status update email:", error);
    }
}
}),
"[project]/app/api/bookings/route.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "GET",
    ()=>GET,
    "POST",
    ()=>POST
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/lib/supabase/server.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$0_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/next@16.0.0_@opentelemetry+api@1.9.0_react-dom@19.2.0_react@19.2.0__react@19.2.0/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$email$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/lib/email.ts [app-route] (ecmascript)");
;
;
;
async function GET(request) {
    try {
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServerClient"])();
        const searchParams = request.nextUrl.searchParams;
        const shopId = searchParams.get("shop_id");
        const userId = searchParams.get("user_id");
        let query = supabase.from("bookings").select("*").order("appointment_date", {
            ascending: true
        }).order("appointment_time", {
            ascending: true
        });
        if (shopId) {
            query = query.eq("shop_id", shopId);
        }
        if (userId) {
            query = query.eq("user_id", userId);
        }
        const { data: bookings, error } = await query;
        if (error) throw error;
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$0_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            bookings
        });
    } catch (error) {
        console.error("Error fetching bookings:", error);
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$0_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: "Failed to fetch bookings"
        }, {
            status: 500
        });
    }
}
// Helper function to generate time slots
function generateTimeSlots(startTime, endTime, slotDuration) {
    const slots = [];
    const [startHour, startMin] = startTime.split(":").map(Number);
    const [endHour, endMin] = endTime.split(":").map(Number);
    let currentHour = startHour;
    let currentMin = startMin;
    while(currentHour < endHour || currentHour === endHour && currentMin < endMin){
        slots.push(`${currentHour.toString().padStart(2, "0")}:${currentMin.toString().padStart(2, "0")}`);
        currentMin += slotDuration;
        if (currentMin >= 60) {
            currentMin = 0;
            currentHour++;
        }
    }
    return slots;
}
// Helper function to find alternative time slots
function findAlternativeSlots(requestedTime, bookedSlots, allSlots, bufferMinutes) {
    const alternatives = [];
    const [reqHour, reqMin] = requestedTime.split(":").map(Number);
    const reqMinutes = reqHour * 60 + reqMin;
    // Check slots before and after the requested time
    for (const slot of allSlots){
        if (bookedSlots.includes(slot)) continue;
        const [slotHour, slotMin] = slot.split(":").map(Number);
        const slotMinutes = slotHour * 60 + slotMin;
        const diff = Math.abs(slotMinutes - reqMinutes);
        // Only suggest slots within 2 hours and respecting buffer time
        if (diff >= bufferMinutes && diff <= 120) {
            alternatives.push(slot);
        }
    }
    // Sort by proximity to requested time
    return alternatives.sort((a, b)=>{
        const [aHour, aMin] = a.split(":").map(Number);
        const [bHour, bMin] = b.split(":").map(Number);
        const aMinutes = aHour * 60 + aMin;
        const bMinutes = bHour * 60 + bMin;
        return Math.abs(aMinutes - reqMinutes) - Math.abs(bMinutes - reqMinutes);
    }).slice(0, 3) // Return top 3 alternatives
    ;
}
async function POST(request) {
    try {
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServerClient"])();
        const body = await request.json();
        const { shop_id, diagnosis_id, appointment_date, appointment_time, notes, user_name, user_email, user_phone } = body;
        // Validate required fields
        if (!shop_id || !appointment_date || !appointment_time || !user_name || !user_email) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$0_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: "Missing required fields"
            }, {
                status: 400
            });
        }
        // Check if user is authenticated
        const { data: { user } } = await supabase.auth.getUser();
        // Fetch shop with booking preferences
        const { data: shop, error: shopError } = await supabase.from("repair_shops").select("id, booking_preferences").eq("id", shop_id).single();
        if (shopError || !shop) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$0_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: "Shop not found"
            }, {
                status: 404
            });
        }
        // Get booking preferences with defaults
        const prefs = shop.booking_preferences || {
            max_bookings_per_day: 10,
            max_bookings_per_slot: 1,
            working_hours: {
                start: "09:00",
                end: "17:00"
            },
            slot_duration_minutes: 30,
            buffer_time_minutes: 15,
            advance_booking_days: 30,
            same_day_booking_allowed: true,
            auto_confirm: false,
            require_phone: false
        };
        // Validate same-day booking
        const today = new Date().toISOString().split("T")[0];
        if (appointment_date === today && !prefs.same_day_booking_allowed) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$0_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: "Same-day bookings are not allowed. Please book for a future date."
            }, {
                status: 400
            });
        }
        // Validate advance booking limit
        const appointmentDate = new Date(appointment_date);
        const maxDate = new Date();
        maxDate.setDate(maxDate.getDate() + (prefs.advance_booking_days || 30));
        if (appointmentDate > maxDate) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$0_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: `Bookings can only be made up to ${prefs.advance_booking_days} days in advance.`
            }, {
                status: 400
            });
        }
        // Validate working hours
        const [workStart, workEnd] = [
            prefs.working_hours?.start || "09:00",
            prefs.working_hours?.end || "17:00"
        ];
        if (appointment_time < workStart || appointment_time >= workEnd) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$0_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: `Bookings are only available between ${workStart} and ${workEnd}.`
            }, {
                status: 400
            });
        }
        // Check total bookings for the day
        const { data: dayBookings, error: dayBookingsError } = await supabase.from("bookings").select("id").eq("shop_id", shop_id).eq("appointment_date", appointment_date).in("status", [
            "pending",
            "confirmed"
        ]);
        if (dayBookingsError) {
            console.error("Error checking day bookings:", dayBookingsError);
        }
        const bookingsCount = dayBookings?.length || 0;
        if (bookingsCount >= (prefs.max_bookings_per_day || 10)) {
            // Find alternative dates
            const { data: upcomingBookings } = await supabase.from("bookings").select("appointment_date").eq("shop_id", shop_id).gte("appointment_date", appointment_date).in("status", [
                "pending",
                "confirmed"
            ]).order("appointment_date", {
                ascending: true
            }).limit(10);
            const bookedDates = new Set(upcomingBookings?.map((b)=>b.appointment_date) || []);
            const alternativeDates = [];
            let checkDate = new Date(appointment_date);
            for(let i = 0; i < 7 && alternativeDates.length < 3; i++){
                checkDate.setDate(checkDate.getDate() + 1);
                const dateStr = checkDate.toISOString().split("T")[0];
                if (!bookedDates.has(dateStr)) {
                    alternativeDates.push(dateStr);
                }
            }
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$0_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: `This shop has reached its daily booking limit (${prefs.max_bookings_per_day} bookings/day).`,
                alternativeDates: alternativeDates.length > 0 ? alternativeDates : undefined
            }, {
                status: 400
            });
        }
        // Check bookings for the specific time slot
        const { data: slotBookings, error: slotBookingsError } = await supabase.from("bookings").select("id, appointment_time").eq("shop_id", shop_id).eq("appointment_date", appointment_date).in("status", [
            "pending",
            "confirmed"
        ]);
        if (slotBookingsError) {
            console.error("Error checking slot bookings:", slotBookingsError);
        }
        const slotBookingsCount = slotBookings?.filter((b)=>b.appointment_time === appointment_time).length || 0;
        if (slotBookingsCount >= (prefs.max_bookings_per_slot || 1)) {
            // Find alternative time slots
            const allSlots = generateTimeSlots(workStart, workEnd, prefs.slot_duration_minutes || 30);
            const bookedSlots = slotBookings?.map((b)=>b.appointment_time) || [];
            const alternatives = findAlternativeSlots(appointment_time, bookedSlots, allSlots, prefs.buffer_time_minutes || 15);
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$0_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: "This time slot is already fully booked.",
                alternativeTimes: alternatives.length > 0 ? alternatives : undefined
            }, {
                status: 400
            });
        }
        // Validate phone requirement
        if (prefs.require_phone && !user_phone) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$0_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: "Phone number is required for booking with this shop."
            }, {
                status: 400
            });
        }
        // Final check right before inserting to prevent race conditions
        const { data: finalCheckBookings } = await supabase.from("bookings").select("id, appointment_time").eq("shop_id", shop_id).eq("appointment_date", appointment_date).eq("appointment_time", appointment_time).in("status", [
            "pending",
            "confirmed"
        ]);
        const finalSlotCount = finalCheckBookings?.length || 0;
        if (finalSlotCount >= (prefs.max_bookings_per_slot || 1)) {
            // Find alternative time slots
            const allSlots = generateTimeSlots(workStart, workEnd, prefs.slot_duration_minutes || 30);
            const bookedSlots = finalCheckBookings?.map((b)=>b.appointment_time) || [];
            const alternatives = findAlternativeSlots(appointment_time, bookedSlots, allSlots, prefs.buffer_time_minutes || 15);
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$0_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: "This time slot was just booked by someone else. Please select another time.",
                alternativeTimes: alternatives.length > 0 ? alternatives : undefined
            }, {
                status: 409
            } // 409 Conflict
            );
        }
        // Fetch shop details for email
        const { data: shopDetails } = await supabase.from("repair_shops").select("name, email, phone, address").eq("id", shop_id).single();
        // Create booking
        const bookingStatus = prefs.auto_confirm ? "confirmed" : "pending";
        const { data: booking, error } = await supabase.from("bookings").insert({
            shop_id,
            diagnosis_id: diagnosis_id || null,
            user_id: user?.id || null,
            appointment_date,
            appointment_time,
            notes,
            user_name,
            user_email,
            user_phone,
            status: bookingStatus
        }).select().single();
        if (error) {
            console.error("Error creating booking:", error);
            throw error;
        }
        // Send email notification (async, don't wait for it)
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$email$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["sendBookingConfirmationEmail"])({
            bookingId: booking.id,
            userName: user_name,
            userEmail: user_email,
            shopName: shopDetails?.name || "Repair Shop",
            shopEmail: shopDetails?.email,
            shopAddress: shopDetails?.address,
            shopPhone: shopDetails?.phone,
            appointmentDate: appointment_date,
            appointmentTime: appointment_time,
            status: bookingStatus,
            notes: notes || null
        }).catch((err)=>{
            console.error("Failed to send booking email:", err);
        });
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$0_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            booking,
            message: bookingStatus === "confirmed" ? "Booking confirmed automatically based on shop preferences." : "Booking created successfully. Waiting for shop confirmation."
        }, {
            status: 201
        });
    } catch (error) {
        console.error("Error creating booking:", error);
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$0_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: "Failed to create booking"
        }, {
            status: 500
        });
    }
}
}),
];

//# sourceMappingURL=%5Broot-of-the-server%5D__b3ebb8a6._.js.map
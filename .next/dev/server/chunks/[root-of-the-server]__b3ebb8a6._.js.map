{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///Users/ss/Downloads/ai-repair-diagnosis-saas-main/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient as createSupabaseServerClient } from \"@supabase/ssr\"\nimport { cookies } from \"next/headers\"\n\nexport async function createServerClient() {\n  const cookieStore = await cookies()\n\n  return createSupabaseServerClient(process.env.NEXT_PUBLIC_SUPABASE_URL!, process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!, {\n    cookies: {\n      getAll() {\n        return cookieStore.getAll()\n      },\n      setAll(cookiesToSet) {\n        try {\n          cookiesToSet.forEach(({ name, value, options }) => cookieStore.set(name, value, options))\n        } catch {\n          // The \"setAll\" method was called from a Server Component.\n          // This can be ignored if you have middleware refreshing\n          // user sessions.\n        }\n      },\n    },\n  })\n}\n\nexport const createClient = createServerClient\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;AACA;;;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,mTAAO;IAEjC,OAAO,IAAA,8SAA0B,sUAAoF;QACnH,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAAK,YAAY,GAAG,CAAC,MAAM,OAAO;gBAClF,EAAE,OAAM;gBACN,0DAA0D;gBAC1D,wDAAwD;gBACxD,iBAAiB;gBACnB;YACF;QACF;IACF;AACF;AAEO,MAAM,eAAe","debugId":null}},
    {"offset": {"line": 81, "column": 0}, "map": {"version":3,"sources":["file:///Users/ss/Downloads/ai-repair-diagnosis-saas-main/lib/email.ts"],"sourcesContent":["import { Resend } from \"resend\"\n\nconst resend = new Resend(process.env.RESEND_API_KEY)\n\nexport interface BookingEmailData {\n  bookingId: string\n  userName: string\n  userEmail: string\n  shopName: string\n  shopEmail?: string\n  appointmentDate: string\n  appointmentTime: string\n  status: \"pending\" | \"confirmed\" | \"completed\" | \"cancelled\"\n  notes?: string | null\n  shopAddress?: string\n  shopPhone?: string\n}\n\nexport async function sendBookingConfirmationEmail(data: BookingEmailData) {\n  if (!process.env.RESEND_API_KEY) {\n    console.warn(\"RESEND_API_KEY not configured, skipping email\")\n    return\n  }\n\n  const fromEmail = process.env.RESEND_FROM_EMAIL || \"noreply@fixwise.com\"\n  const formattedDate = new Date(data.appointmentDate).toLocaleDateString(\"en-US\", {\n    weekday: \"long\",\n    year: \"numeric\",\n    month: \"long\",\n    day: \"numeric\",\n  })\n\n  try {\n    await resend.emails.send({\n      from: fromEmail,\n      to: data.userEmail,\n      subject: `Booking ${data.status === \"confirmed\" ? \"Confirmed\" : \"Received\"} - ${data.shopName}`,\n      html: `\n        <!DOCTYPE html>\n        <html>\n          <head>\n            <meta charset=\"utf-8\">\n            <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n            <title>Booking ${data.status === \"confirmed\" ? \"Confirmed\" : \"Received\"}</title>\n          </head>\n          <body style=\"font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;\">\n            <div style=\"background: linear-gradient(135deg, #1A2332 0%, #2D3748 100%); padding: 30px; text-align: center; border-radius: 10px 10px 0 0;\">\n              <h1 style=\"color: #fff; margin: 0;\">FixWise</h1>\n            </div>\n            \n            <div style=\"background: #f9fafb; padding: 30px; border-radius: 0 0 10px 10px; border: 1px solid #e5e7eb;\">\n              <h2 style=\"color: #1A2332; margin-top: 0;\">\n                ${data.status === \"confirmed\" ? \"‚úÖ Booking Confirmed!\" : \"üìÖ Booking Received\"}\n              </h2>\n              \n              <p>Hello ${data.userName},</p>\n              \n              <p>\n                ${data.status === \"confirmed\" \n                  ? \"Great news! Your booking has been confirmed by the repair shop.\" \n                  : \"Your booking request has been received and is pending confirmation from the repair shop.\"}\n              </p>\n              \n              <div style=\"background: #fff; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #1A2332;\">\n                <h3 style=\"margin-top: 0; color: #1A2332;\">Booking Details</h3>\n                <p><strong>Shop:</strong> ${data.shopName}</p>\n                <p><strong>Date:</strong> ${formattedDate}</p>\n                <p><strong>Time:</strong> ${data.appointmentTime}</p>\n                ${data.shopAddress ? `<p><strong>Address:</strong> ${data.shopAddress}</p>` : \"\"}\n                ${data.shopPhone ? `<p><strong>Phone:</strong> ${data.shopPhone}</p>` : \"\"}\n                ${data.notes ? `<p><strong>Notes:</strong> ${data.notes}</p>` : \"\"}\n                <p><strong>Status:</strong> <span style=\"text-transform: capitalize; font-weight: bold; color: ${\n                  data.status === \"confirmed\" ? \"#10b981\" : \n                  data.status === \"completed\" ? \"#3b82f6\" : \n                  data.status === \"cancelled\" ? \"#ef4444\" : \"#f59e0b\"\n                };\">${data.status}</span></p>\n              </div>\n              \n              ${data.status === \"pending\" ? `\n                <p style=\"color: #6b7280; font-size: 14px;\">\n                  You will receive another email once the shop confirms your booking.\n                </p>\n              ` : \"\"}\n              \n              ${data.status === \"confirmed\" ? `\n                <p style=\"color: #059669; font-weight: bold;\">\n                  Please arrive on time for your appointment. If you need to reschedule or cancel, please contact the shop directly.\n                </p>\n              ` : \"\"}\n              \n              <div style=\"margin-top: 30px; padding-top: 20px; border-top: 1px solid #e5e7eb; text-align: center; color: #6b7280; font-size: 12px;\">\n                <p>This is an automated email from FixWise. Please do not reply to this email.</p>\n                <p>If you have questions, please contact ${data.shopEmail || \"the repair shop\"} directly.</p>\n              </div>\n            </div>\n          </body>\n        </html>\n      `,\n    })\n\n    // Also send notification to shop owner if email is available\n    if (data.shopEmail && data.status === \"pending\") {\n      await resend.emails.send({\n        from: fromEmail,\n        to: data.shopEmail,\n        subject: `New Booking Request - ${data.userName}`,\n        html: `\n          <!DOCTYPE html>\n          <html>\n            <head>\n              <meta charset=\"utf-8\">\n              <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n              <title>New Booking Request</title>\n            </head>\n            <body style=\"font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;\">\n              <div style=\"background: linear-gradient(135deg, #1A2332 0%, #2D3748 100%); padding: 30px; text-align: center; border-radius: 10px 10px 0 0;\">\n                <h1 style=\"color: #fff; margin: 0;\">FixWise</h1>\n              </div>\n              \n              <div style=\"background: #f9fafb; padding: 30px; border-radius: 0 0 10px 10px; border: 1px solid #e5e7eb;\">\n                <h2 style=\"color: #1A2332; margin-top: 0;\">üìÖ New Booking Request</h2>\n                \n                <p>Hello,</p>\n                \n                <p>You have received a new booking request for <strong>${data.shopName}</strong>.</p>\n                \n                <div style=\"background: #fff; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #1A2332;\">\n                  <h3 style=\"margin-top: 0; color: #1A2332;\">Booking Details</h3>\n                  <p><strong>Customer:</strong> ${data.userName}</p>\n                  <p><strong>Email:</strong> ${data.userEmail}</p>\n                  <p><strong>Date:</strong> ${formattedDate}</p>\n                  <p><strong>Time:</strong> ${data.appointmentTime}</p>\n                  ${data.notes ? `<p><strong>Notes:</strong> ${data.notes}</p>` : \"\"}\n                  <p><strong>Status:</strong> <span style=\"text-transform: capitalize; font-weight: bold; color: #f59e0b;\">Pending</span></p>\n                </div>\n                \n                <p style=\"color: #059669; font-weight: bold;\">\n                  Please log in to your dashboard to confirm or manage this booking.\n                </p>\n                \n                <div style=\"margin-top: 30px; padding-top: 20px; border-top: 1px solid #e5e7eb; text-align: center; color: #6b7280; font-size: 12px;\">\n                  <p>This is an automated email from FixWise.</p>\n                </div>\n              </div>\n            </body>\n          </html>\n        `,\n      })\n    }\n  } catch (error) {\n    console.error(\"Error sending booking email:\", error)\n    // Don't throw - email failures shouldn't break the booking process\n  }\n}\n\nexport async function sendBookingStatusUpdateEmail(data: BookingEmailData) {\n  if (!process.env.RESEND_API_KEY) {\n    console.warn(\"RESEND_API_KEY not configured, skipping email\")\n    return\n  }\n\n  const fromEmail = process.env.RESEND_FROM_EMAIL || \"noreply@fixwise.com\"\n  const formattedDate = new Date(data.appointmentDate).toLocaleDateString(\"en-US\", {\n    weekday: \"long\",\n    year: \"numeric\",\n    month: \"long\",\n    day: \"numeric\",\n  })\n\n  const statusMessages: Record<string, { subject: string; message: string; color: string }> = {\n    confirmed: {\n      subject: \"Booking Confirmed\",\n      message: \"Great news! Your booking has been confirmed.\",\n      color: \"#10b981\",\n    },\n    cancelled: {\n      subject: \"Booking Cancelled\",\n      message: \"Your booking has been cancelled.\",\n      color: \"#ef4444\",\n    },\n    completed: {\n      subject: \"Booking Completed\",\n      message: \"Your booking has been marked as completed.\",\n      color: \"#3b82f6\",\n    },\n  }\n\n  const statusInfo = statusMessages[data.status] || {\n    subject: \"Booking Status Updated\",\n    message: \"Your booking status has been updated.\",\n    color: \"#6b7280\",\n  }\n\n  try {\n    await resend.emails.send({\n      from: fromEmail,\n      to: data.userEmail,\n      subject: `${statusInfo.subject} - ${data.shopName}`,\n      html: `\n        <!DOCTYPE html>\n        <html>\n          <head>\n            <meta charset=\"utf-8\">\n            <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n            <title>${statusInfo.subject}</title>\n          </head>\n          <body style=\"font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;\">\n            <div style=\"background: linear-gradient(135deg, #1A2332 0%, #2D3748 100%); padding: 30px; text-align: center; border-radius: 10px 10px 0 0;\">\n              <h1 style=\"color: #fff; margin: 0;\">FixWise</h1>\n            </div>\n            \n            <div style=\"background: #f9fafb; padding: 30px; border-radius: 0 0 10px 10px; border: 1px solid #e5e7eb;\">\n              <h2 style=\"color: #1A2332; margin-top: 0;\">\n                ${data.status === \"confirmed\" ? \"‚úÖ Booking Confirmed!\" : \n                  data.status === \"cancelled\" ? \"‚ùå Booking Cancelled\" : \n                  \"‚úÖ Booking Completed\"}\n              </h2>\n              \n              <p>Hello ${data.userName},</p>\n              \n              <p>${statusInfo.message}</p>\n              \n              <div style=\"background: #fff; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid ${statusInfo.color};\">\n                <h3 style=\"margin-top: 0; color: #1A2332;\">Booking Details</h3>\n                <p><strong>Shop:</strong> ${data.shopName}</p>\n                <p><strong>Date:</strong> ${formattedDate}</p>\n                <p><strong>Time:</strong> ${data.appointmentTime}</p>\n                <p><strong>Status:</strong> <span style=\"text-transform: capitalize; font-weight: bold; color: ${statusInfo.color};\">${data.status}</span></p>\n              </div>\n              \n              ${data.status === \"confirmed\" ? `\n                <p style=\"color: #059669; font-weight: bold;\">\n                  Please arrive on time for your appointment. If you need to reschedule or cancel, please contact the shop directly.\n                </p>\n              ` : data.status === \"cancelled\" ? `\n                <p style=\"color: #6b7280;\">\n                  If you need to book a new appointment, please visit our website or contact the shop directly.\n                </p>\n              ` : \"\"}\n              \n              <div style=\"margin-top: 30px; padding-top: 20px; border-top: 1px solid #e5e7eb; text-align: center; color: #6b7280; font-size: 12px;\">\n                <p>This is an automated email from FixWise. Please do not reply to this email.</p>\n                <p>If you have questions, please contact ${data.shopEmail || \"the repair shop\"} directly.</p>\n              </div>\n            </div>\n          </body>\n        </html>\n      `,\n    })\n  } catch (error) {\n    console.error(\"Error sending status update email:\", error)\n  }\n}\n\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 313, "column": 0}, "map": {"version":3,"sources":["file:///Users/ss/Downloads/ai-repair-diagnosis-saas-main/app/api/bookings/route.ts"],"sourcesContent":["import { createServerClient } from \"@/lib/supabase/server\"\nimport { type NextRequest, NextResponse } from \"next/server\"\nimport { sendBookingConfirmationEmail } from \"@/lib/email\"\n\nexport async function GET(request: NextRequest) {\n  try {\n    const supabase = await createServerClient()\n    const searchParams = request.nextUrl.searchParams\n    const shopId = searchParams.get(\"shop_id\")\n    const userId = searchParams.get(\"user_id\")\n\n    let query = supabase\n      .from(\"bookings\")\n      .select(\"*\")\n      .order(\"appointment_date\", { ascending: true })\n      .order(\"appointment_time\", { ascending: true })\n\n    if (shopId) {\n      query = query.eq(\"shop_id\", shopId)\n    }\n\n    if (userId) {\n      query = query.eq(\"user_id\", userId)\n    }\n\n    const { data: bookings, error } = await query\n\n    if (error) throw error\n\n    return NextResponse.json({ bookings })\n  } catch (error) {\n    console.error(\"Error fetching bookings:\", error)\n    return NextResponse.json({ error: \"Failed to fetch bookings\" }, { status: 500 })\n  }\n}\n\n// Helper function to generate time slots\nfunction generateTimeSlots(startTime: string, endTime: string, slotDuration: number): string[] {\n  const slots: string[] = []\n  const [startHour, startMin] = startTime.split(\":\").map(Number)\n  const [endHour, endMin] = endTime.split(\":\").map(Number)\n  \n  let currentHour = startHour\n  let currentMin = startMin\n  \n  while (currentHour < endHour || (currentHour === endHour && currentMin < endMin)) {\n    slots.push(`${currentHour.toString().padStart(2, \"0\")}:${currentMin.toString().padStart(2, \"0\")}`)\n    currentMin += slotDuration\n    if (currentMin >= 60) {\n      currentMin = 0\n      currentHour++\n    }\n  }\n  \n  return slots\n}\n\n// Helper function to find alternative time slots\nfunction findAlternativeSlots(\n  requestedTime: string,\n  bookedSlots: string[],\n  allSlots: string[],\n  bufferMinutes: number\n): string[] {\n  const alternatives: string[] = []\n  const [reqHour, reqMin] = requestedTime.split(\":\").map(Number)\n  const reqMinutes = reqHour * 60 + reqMin\n  \n  // Check slots before and after the requested time\n  for (const slot of allSlots) {\n    if (bookedSlots.includes(slot)) continue\n    \n    const [slotHour, slotMin] = slot.split(\":\").map(Number)\n    const slotMinutes = slotHour * 60 + slotMin\n    const diff = Math.abs(slotMinutes - reqMinutes)\n    \n    // Only suggest slots within 2 hours and respecting buffer time\n    if (diff >= bufferMinutes && diff <= 120) {\n      alternatives.push(slot)\n    }\n  }\n  \n  // Sort by proximity to requested time\n  return alternatives.sort((a, b) => {\n    const [aHour, aMin] = a.split(\":\").map(Number)\n    const [bHour, bMin] = b.split(\":\").map(Number)\n    const aMinutes = aHour * 60 + aMin\n    const bMinutes = bHour * 60 + bMin\n    return Math.abs(aMinutes - reqMinutes) - Math.abs(bMinutes - reqMinutes)\n  }).slice(0, 3) // Return top 3 alternatives\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const supabase = await createServerClient()\n    const body = await request.json()\n    const { shop_id, diagnosis_id, appointment_date, appointment_time, notes, user_name, user_email, user_phone } = body\n\n    // Validate required fields\n    if (!shop_id || !appointment_date || !appointment_time || !user_name || !user_email) {\n      return NextResponse.json({ error: \"Missing required fields\" }, { status: 400 })\n    }\n\n    // Check if user is authenticated\n    const {\n      data: { user },\n    } = await supabase.auth.getUser()\n\n    // Fetch shop with booking preferences\n    const { data: shop, error: shopError } = await supabase\n      .from(\"repair_shops\")\n      .select(\"id, booking_preferences\")\n      .eq(\"id\", shop_id)\n      .single()\n\n    if (shopError || !shop) {\n      return NextResponse.json({ error: \"Shop not found\" }, { status: 404 })\n    }\n\n    // Get booking preferences with defaults\n    const prefs = shop.booking_preferences || {\n      max_bookings_per_day: 10,\n      max_bookings_per_slot: 1,\n      working_hours: { start: \"09:00\", end: \"17:00\" },\n      slot_duration_minutes: 30,\n      buffer_time_minutes: 15,\n      advance_booking_days: 30,\n      same_day_booking_allowed: true,\n      auto_confirm: false,\n      require_phone: false,\n    }\n\n    // Validate same-day booking\n    const today = new Date().toISOString().split(\"T\")[0]\n    if (appointment_date === today && !prefs.same_day_booking_allowed) {\n      return NextResponse.json(\n        { error: \"Same-day bookings are not allowed. Please book for a future date.\" },\n        { status: 400 }\n      )\n    }\n\n    // Validate advance booking limit\n    const appointmentDate = new Date(appointment_date)\n    const maxDate = new Date()\n    maxDate.setDate(maxDate.getDate() + (prefs.advance_booking_days || 30))\n    if (appointmentDate > maxDate) {\n      return NextResponse.json(\n        { error: `Bookings can only be made up to ${prefs.advance_booking_days} days in advance.` },\n        { status: 400 }\n      )\n    }\n\n    // Validate working hours\n    const [workStart, workEnd] = [prefs.working_hours?.start || \"09:00\", prefs.working_hours?.end || \"17:00\"]\n    if (appointment_time < workStart || appointment_time >= workEnd) {\n      return NextResponse.json(\n        { error: `Bookings are only available between ${workStart} and ${workEnd}.` },\n        { status: 400 }\n      )\n    }\n\n    // Check total bookings for the day\n    const { data: dayBookings, error: dayBookingsError } = await supabase\n      .from(\"bookings\")\n      .select(\"id\")\n      .eq(\"shop_id\", shop_id)\n      .eq(\"appointment_date\", appointment_date)\n      .in(\"status\", [\"pending\", \"confirmed\"])\n\n    if (dayBookingsError) {\n      console.error(\"Error checking day bookings:\", dayBookingsError)\n    }\n\n    const bookingsCount = dayBookings?.length || 0\n    if (bookingsCount >= (prefs.max_bookings_per_day || 10)) {\n      // Find alternative dates\n      const { data: upcomingBookings } = await supabase\n        .from(\"bookings\")\n        .select(\"appointment_date\")\n        .eq(\"shop_id\", shop_id)\n        .gte(\"appointment_date\", appointment_date)\n        .in(\"status\", [\"pending\", \"confirmed\"])\n        .order(\"appointment_date\", { ascending: true })\n        .limit(10)\n\n      const bookedDates = new Set(upcomingBookings?.map((b: any) => b.appointment_date) || [])\n      const alternativeDates: string[] = []\n      let checkDate = new Date(appointment_date)\n      \n      for (let i = 0; i < 7 && alternativeDates.length < 3; i++) {\n        checkDate.setDate(checkDate.getDate() + 1)\n        const dateStr = checkDate.toISOString().split(\"T\")[0]\n        if (!bookedDates.has(dateStr)) {\n          alternativeDates.push(dateStr)\n        }\n      }\n\n      return NextResponse.json(\n        {\n          error: `This shop has reached its daily booking limit (${prefs.max_bookings_per_day} bookings/day).`,\n          alternativeDates: alternativeDates.length > 0 ? alternativeDates : undefined,\n        },\n        { status: 400 }\n      )\n    }\n\n    // Check bookings for the specific time slot\n    const { data: slotBookings, error: slotBookingsError } = await supabase\n      .from(\"bookings\")\n      .select(\"id, appointment_time\")\n      .eq(\"shop_id\", shop_id)\n      .eq(\"appointment_date\", appointment_date)\n      .in(\"status\", [\"pending\", \"confirmed\"])\n\n    if (slotBookingsError) {\n      console.error(\"Error checking slot bookings:\", slotBookingsError)\n    }\n\n    const slotBookingsCount = slotBookings?.filter((b: any) => b.appointment_time === appointment_time).length || 0\n    if (slotBookingsCount >= (prefs.max_bookings_per_slot || 1)) {\n      // Find alternative time slots\n      const allSlots = generateTimeSlots(workStart, workEnd, prefs.slot_duration_minutes || 30)\n      const bookedSlots = slotBookings?.map((b: any) => b.appointment_time) || []\n      const alternatives = findAlternativeSlots(\n        appointment_time,\n        bookedSlots,\n        allSlots,\n        prefs.buffer_time_minutes || 15\n      )\n\n      return NextResponse.json(\n        {\n          error: \"This time slot is already fully booked.\",\n          alternativeTimes: alternatives.length > 0 ? alternatives : undefined,\n        },\n        { status: 400 }\n      )\n    }\n\n    // Validate phone requirement\n    if (prefs.require_phone && !user_phone) {\n      return NextResponse.json(\n        { error: \"Phone number is required for booking with this shop.\" },\n        { status: 400 }\n      )\n    }\n\n    // Final check right before inserting to prevent race conditions\n    const { data: finalCheckBookings } = await supabase\n      .from(\"bookings\")\n      .select(\"id, appointment_time\")\n      .eq(\"shop_id\", shop_id)\n      .eq(\"appointment_date\", appointment_date)\n      .eq(\"appointment_time\", appointment_time)\n      .in(\"status\", [\"pending\", \"confirmed\"])\n\n    const finalSlotCount = finalCheckBookings?.length || 0\n    if (finalSlotCount >= (prefs.max_bookings_per_slot || 1)) {\n      // Find alternative time slots\n      const allSlots = generateTimeSlots(workStart, workEnd, prefs.slot_duration_minutes || 30)\n      const bookedSlots = finalCheckBookings?.map((b: any) => b.appointment_time) || []\n      const alternatives = findAlternativeSlots(\n        appointment_time,\n        bookedSlots,\n        allSlots,\n        prefs.buffer_time_minutes || 15\n      )\n\n      return NextResponse.json(\n        {\n          error: \"This time slot was just booked by someone else. Please select another time.\",\n          alternativeTimes: alternatives.length > 0 ? alternatives : undefined,\n        },\n        { status: 409 } // 409 Conflict\n      )\n    }\n\n    // Fetch shop details for email\n    const { data: shopDetails } = await supabase\n      .from(\"repair_shops\")\n      .select(\"name, email, phone, address\")\n      .eq(\"id\", shop_id)\n      .single()\n\n    // Create booking\n    const bookingStatus = prefs.auto_confirm ? \"confirmed\" : \"pending\"\n    const { data: booking, error } = await supabase\n      .from(\"bookings\")\n      .insert({\n        shop_id,\n        diagnosis_id: diagnosis_id || null,\n        user_id: user?.id || null,\n        appointment_date,\n        appointment_time,\n        notes,\n        user_name,\n        user_email,\n        user_phone,\n        status: bookingStatus,\n      })\n      .select()\n      .single()\n\n    if (error) {\n      console.error(\"Error creating booking:\", error)\n      throw error\n    }\n\n    // Send email notification (async, don't wait for it)\n    sendBookingConfirmationEmail({\n      bookingId: booking.id,\n      userName: user_name,\n      userEmail: user_email,\n      shopName: shopDetails?.name || \"Repair Shop\",\n      shopEmail: shopDetails?.email,\n      shopAddress: shopDetails?.address,\n      shopPhone: shopDetails?.phone,\n      appointmentDate: appointment_date,\n      appointmentTime: appointment_time,\n      status: bookingStatus,\n      notes: notes || null,\n    }).catch((err) => {\n      console.error(\"Failed to send booking email:\", err)\n    })\n\n    return NextResponse.json({\n      booking,\n      message: bookingStatus === \"confirmed\" \n        ? \"Booking confirmed automatically based on shop preferences.\"\n        : \"Booking created successfully. Waiting for shop confirmation.\",\n    }, { status: 201 })\n  } catch (error) {\n    console.error(\"Error creating booking:\", error)\n    return NextResponse.json({ error: \"Failed to create booking\" }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}
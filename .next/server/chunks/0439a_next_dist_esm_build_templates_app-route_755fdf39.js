module.exports=[28910,e=>{"use strict";var t=e.i(11432),n=e.i(86130),o=e.i(93330),a=e.i(21955),r=e.i(99782),i=e.i(3086),s=e.i(31248),l=e.i(88336),d=e.i(84027),p=e.i(85624),u=e.i(99936),c=e.i(19025),m=e.i(44236),h=e.i(60975),g=e.i(27223),f=e.i(51941),_=e.i(93695);e.i(43985);var b=e.i(35005),R=e.i(89660),v=e.i(19842),k=e.i(133);async function w(e){try{let t=await (0,R.createServerClient)(),n=e.nextUrl.searchParams,o=n.get("shop_id"),a=n.get("user_id"),r=t.from("bookings").select("*").order("appointment_date",{ascending:!0}).order("appointment_time",{ascending:!0});o&&(r=r.eq("shop_id",o)),a&&(r=r.eq("user_id",a));let{data:i,error:s}=await r;if(s)throw s;return v.NextResponse.json({bookings:i})}catch(e){return console.error("Error fetching bookings:",e),v.NextResponse.json({error:"Failed to fetch bookings"},{status:500})}}function y(e,t,n){let o=[],[a,r]=e.split(":").map(Number),[i,s]=t.split(":").map(Number),l=a,d=r;for(;l<i||l===i&&d<s;)o.push(`${l.toString().padStart(2,"0")}:${d.toString().padStart(2,"0")}`),(d+=n)>=60&&(d=0,l++);return o}function x(e,t,n,o){let a=[],[r,i]=e.split(":").map(Number),s=60*r+i;for(let e of n){if(t.includes(e))continue;let[n,r]=e.split(":").map(Number),i=Math.abs(60*n+r-s);i>=o&&i<=120&&a.push(e)}return a.sort((e,t)=>{let[n,o]=e.split(":").map(Number),[a,r]=t.split(":").map(Number);return Math.abs(60*n+o-s)-Math.abs(60*a+r-s)}).slice(0,3)}async function E(e){try{let t=await (0,R.createServerClient)(),{shop_id:n,diagnosis_id:o,appointment_date:a,appointment_time:r,notes:i,user_name:s,user_email:l,user_phone:d,delivery_option:p,delivery_address:u,payment_amount:c}=await e.json();if(!n||!a||!r||!s||!l)return v.NextResponse.json({error:"Missing required fields"},{status:400});if(p&&!["pickup","delivery","mail"].includes(p))return v.NextResponse.json({error:"Invalid delivery option"},{status:400});if(("delivery"===p||"mail"===p)&&!u?.trim())return v.NextResponse.json({error:"Delivery address is required for this delivery option"},{status:400});let{data:{user:m}}=await t.auth.getUser();if(m?.id){let{data:e}=await t.from("bookings").select("id, appointment_date, appointment_time, shop_id").eq("user_id",m.id).eq("appointment_date",a).eq("appointment_time",r).in("status",["pending","confirmed"]).maybeSingle();if(e)return v.NextResponse.json({error:"You already have an appointment at this time slot. Please choose a different time."},{status:409})}if(!m?.id){let{data:e}=await t.from("bookings").select("id, appointment_date, appointment_time").eq("user_email",l).eq("appointment_date",a).eq("appointment_time",r).in("status",["pending","confirmed"]).maybeSingle();if(e)return v.NextResponse.json({error:"You already have an appointment at this time slot. Please choose a different time."},{status:409})}let{data:h,error:g}=await t.from("repair_shops").select("id, booking_preferences").eq("id",n).single();if(g||!h)return v.NextResponse.json({error:"Shop not found"},{status:404});let f=h.booking_preferences||{max_bookings_per_day:10,max_bookings_per_slot:1,working_hours:{start:"09:00",end:"17:00"},slot_duration_minutes:30,buffer_time_minutes:15,advance_booking_days:30,same_day_booking_allowed:!0,auto_confirm:!1,require_phone:!1},_=new Date().toISOString().split("T")[0];if(a===_&&!f.same_day_booking_allowed)return v.NextResponse.json({error:"Same-day bookings are not allowed. Please book for a future date."},{status:400});let b=new Date(a),w=new Date;if(w.setDate(w.getDate()+(f.advance_booking_days||30)),b>w)return v.NextResponse.json({error:`Bookings can only be made up to ${f.advance_booking_days} days in advance.`},{status:400});let[E,N]=[f.working_hours?.start||"09:00",f.working_hours?.end||"17:00"];if(r<E||r>=N)return v.NextResponse.json({error:`Bookings are only available between ${E} and ${N}.`},{status:400});let{data:C,error:q}=await t.from("bookings").select("id").eq("shop_id",n).eq("appointment_date",a).in("status",["pending","confirmed"]);if(q&&console.error("Error checking day bookings:",q),(C?.length||0)>=(f.max_bookings_per_day||10)){let{data:e}=await t.from("bookings").select("appointment_date").eq("shop_id",n).gte("appointment_date",a).in("status",["pending","confirmed"]).order("appointment_date",{ascending:!0}).limit(10),o=new Set(e?.map(e=>e.appointment_date)||[]),r=[],i=new Date(a);for(let e=0;e<7&&r.length<3;e++){i.setDate(i.getDate()+1);let e=i.toISOString().split("T")[0];o.has(e)||r.push(e)}return v.NextResponse.json({error:`This shop has reached its daily booking limit (${f.max_bookings_per_day} bookings/day).`,alternativeDates:r.length>0?r:void 0},{status:400})}let{data:S,error:T}=await t.from("bookings").select("id, appointment_time").eq("shop_id",n).eq("appointment_date",a).in("status",["pending","confirmed"]);if(T&&console.error("Error checking slot bookings:",T),(S?.filter(e=>e.appointment_time===r).length||0)>=(f.max_bookings_per_slot||1)){let e=y(E,N,f.slot_duration_minutes||30),t=S?.map(e=>e.appointment_time)||[],n=x(r,t,e,f.buffer_time_minutes||15);return v.NextResponse.json({error:"This time slot is already fully booked.",alternativeTimes:n.length>0?n:void 0},{status:400})}if(f.require_phone&&!d)return v.NextResponse.json({error:"Phone number is required for booking with this shop."},{status:400});let{data:P}=await t.from("bookings").select("id, appointment_time").eq("shop_id",n).eq("appointment_date",a).eq("appointment_time",r).in("status",["pending","confirmed"]);if((P?.length||0)>=(f.max_bookings_per_slot||1)){let e=y(E,N,f.slot_duration_minutes||30),t=P?.map(e=>e.appointment_time)||[],n=x(r,t,e,f.buffer_time_minutes||15);return v.NextResponse.json({error:"This time slot was just booked by someone else. Please select another time.",alternativeTimes:n.length>0?n:void 0},{status:409})}let{data:A}=await t.from("repair_shops").select("name, email, phone, address").eq("id",n).single(),j=f.auto_confirm?"confirmed":"pending",{data:D,error:O}=await t.from("bookings").insert({shop_id:n,diagnosis_id:o||null,user_id:m?.id||null,appointment_date:a,appointment_time:r,notes:i,user_name:s,user_email:l,user_phone:d,delivery_option:p||"pickup",delivery_address:u||null,payment_amount:c||0,status:j}).select().single();if(O)throw console.error("Error creating booking:",O),O;return(0,k.sendBookingConfirmationEmail)({bookingId:D.id,userName:s,userEmail:l,shopName:A?.name||"Repair Shop",shopEmail:A?.email,shopAddress:A?.address,shopPhone:A?.phone,appointmentDate:a,appointmentTime:r,status:j,notes:i||null}).catch(e=>{console.error("Failed to send booking email:",e)}),v.NextResponse.json({booking:D,message:"confirmed"===j?"Booking confirmed automatically based on shop preferences.":"Booking created successfully. Waiting for shop confirmation."},{status:201})}catch(e){return console.error("Error creating booking:",e),v.NextResponse.json({error:"Failed to create booking"},{status:500})}}e.s(["GET",()=>w,"POST",()=>E],30841);var N=e.i(30841);let C=new t.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/bookings/route",pathname:"/api/bookings",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/bookings/route.ts",nextConfigOutput:"",userland:N}),{workAsyncStorage:q,workUnitAsyncStorage:S,serverHooks:T}=C;function P(){return(0,o.patchFetch)({workAsyncStorage:q,workUnitAsyncStorage:S})}async function A(e,t,o){C.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let R="/api/bookings/route";R=R.replace(/\/index$/,"")||"/";let v=await C.prepare(e,t,{srcPage:R,multiZoneDraftMode:!1});if(!v)return t.statusCode=400,t.end("Bad Request"),null==o.waitUntil||o.waitUntil.call(o,Promise.resolve()),null;let{buildId:k,params:w,nextConfig:y,parsedUrl:x,isDraftMode:E,prerenderManifest:N,routerServerContext:q,isOnDemandRevalidate:S,revalidateOnlyGenerated:T,resolvedPathname:P,clientReferenceManifest:A,serverActionsManifest:j}=v,D=(0,l.normalizeAppPath)(R),O=!!(N.dynamicRoutes[D]||N.routes[P]),M=async()=>((null==q?void 0:q.render404)?await q.render404(e,t,x,!1):t.end("This page could not be found"),null);if(O&&!E){let e=!!N.routes[P],t=N.dynamicRoutes[D];if(t&&!1===t.fallback&&!e){if(y.experimental.adapterPath)return await M();throw new _.NoFallbackError}}let I=null;!O||C.isDev||E||(I="/index"===(I=P)?"/":I);let U=!0===C.isDev||!O,H=O&&!U;j&&A&&(0,i.setReferenceManifestsSingleton)({page:R,clientReferenceManifest:A,serverActionsManifest:j,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:j})});let $=e.method||"GET",F=(0,r.getTracer)(),B=F.getActiveScopeSpan(),K={params:w,prerenderManifest:N,renderOpts:{experimental:{authInterrupts:!!y.experimental.authInterrupts},cacheComponents:!!y.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:y.cacheLife,waitUntil:o.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,n,o)=>C.onRequestError(e,t,o,q)},sharedContext:{buildId:k}},L=new d.NodeNextRequest(e),G=new d.NodeNextResponse(t),V=p.NextRequestAdapter.fromNodeNextRequest(L,(0,p.signalFromNodeResponse)(t));try{let i=async e=>C.handle(V,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let n=F.getRootSpanAttributes();if(!n)return;if(n.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${n.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let o=n.get("next.route");if(o){let t=`${$} ${o}`;e.setAttributes({"next.route":o,"http.route":o,"next.span_name":t}),e.updateName(t)}else e.updateName(`${$} ${R}`)}),s=!!(0,a.getRequestMeta)(e,"minimalMode"),l=async a=>{var r,l;let d=async({previousCacheEntry:n})=>{try{if(!s&&S&&T&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await i(a);e.fetchMetrics=K.renderOpts.fetchMetrics;let l=K.renderOpts.pendingWaitUntil;l&&o.waitUntil&&(o.waitUntil(l),l=void 0);let d=K.renderOpts.collectedTags;if(!O)return await (0,m.sendResponse)(L,G,r,K.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(r.headers);d&&(t[f.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let n=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,o=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:b.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:n,expire:o}}}}catch(t){throw(null==n?void 0:n.isStale)&&await C.onRequestError(e,t,{routerKind:"App Router",routePath:R,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:S})},q),t}},p=await C.handleResponse({req:e,nextConfig:y,cacheKey:I,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:N,isRoutePPREnabled:!1,isOnDemandRevalidate:S,revalidateOnlyGenerated:T,responseGenerator:d,waitUntil:o.waitUntil,isMinimalMode:s});if(!O)return null;if((null==p||null==(r=p.value)?void 0:r.kind)!==b.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==p||null==(l=p.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",S?"REVALIDATED":p.isMiss?"MISS":p.isStale?"STALE":"HIT"),E&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,h.fromNodeOutgoingHttpHeaders)(p.value.headers);return s&&O||u.delete(f.NEXT_CACHE_TAGS_HEADER),!p.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,g.getCacheControlHeader)(p.cacheControl)),await (0,m.sendResponse)(L,G,new Response(p.value.body,{headers:u,status:p.value.status||200})),null};B?await l(B):await F.withPropagatedContext(e.headers,()=>F.trace(u.BaseServerSpan.handleRequest,{spanName:`${$} ${R}`,kind:r.SpanKind.SERVER,attributes:{"http.method":$,"http.target":e.url}},l))}catch(t){if(t instanceof _.NoFallbackError||await C.onRequestError(e,t,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:S})}),O)throw t;return await (0,m.sendResponse)(L,G,new Response(null,{status:500})),null}}e.s(["handler",()=>A,"patchFetch",()=>P,"routeModule",()=>C,"serverHooks",()=>T,"workAsyncStorage",()=>q,"workUnitAsyncStorage",()=>S],28910)}];

//# sourceMappingURL=0439a_next_dist_esm_build_templates_app-route_755fdf39.js.map
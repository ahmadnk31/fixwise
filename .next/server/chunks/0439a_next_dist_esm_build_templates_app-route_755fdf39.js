module.exports=[28910,e=>{"use strict";var t=e.i(11432),n=e.i(86130),o=e.i(93330),r=e.i(21955),a=e.i(99782),i=e.i(3086),s=e.i(31248),l=e.i(88336),d=e.i(84027),u=e.i(85624),p=e.i(99936),c=e.i(19025),m=e.i(44236),h=e.i(60975),g=e.i(27223),f=e.i(51941),_=e.i(93695);e.i(43985);var b=e.i(35005),R=e.i(89660),w=e.i(19842),k=e.i(133);async function v(e){try{let t=await (0,R.createServerClient)(),n=e.nextUrl.searchParams,o=n.get("shop_id"),r=n.get("user_id"),a=t.from("bookings").select("*").order("appointment_date",{ascending:!0}).order("appointment_time",{ascending:!0});o&&(a=a.eq("shop_id",o)),r&&(a=a.eq("user_id",r));let{data:i,error:s}=await a;if(s)throw s;return w.NextResponse.json({bookings:i})}catch(e){return console.error("Error fetching bookings:",e),w.NextResponse.json({error:"Failed to fetch bookings"},{status:500})}}function x(e,t,n){let o=[],[r,a]=e.split(":").map(Number),[i,s]=t.split(":").map(Number),l=r,d=a;for(;l<i||l===i&&d<s;)o.push(`${l.toString().padStart(2,"0")}:${d.toString().padStart(2,"0")}`),(d+=n)>=60&&(d=0,l++);return o}function y(e,t,n,o){let r=[],[a,i]=e.split(":").map(Number),s=60*a+i;for(let e of n){if(t.includes(e))continue;let[n,a]=e.split(":").map(Number),i=Math.abs(60*n+a-s);i>=o&&i<=120&&r.push(e)}return r.sort((e,t)=>{let[n,o]=e.split(":").map(Number),[r,a]=t.split(":").map(Number);return Math.abs(60*n+o-s)-Math.abs(60*r+a-s)}).slice(0,3)}async function E(e){try{let t=await (0,R.createServerClient)(),{shop_id:n,diagnosis_id:o,appointment_date:r,appointment_time:a,notes:i,user_name:s,user_email:l,user_phone:d}=await e.json();if(!n||!r||!a||!s||!l)return w.NextResponse.json({error:"Missing required fields"},{status:400});let{data:{user:u}}=await t.auth.getUser(),{data:p,error:c}=await t.from("repair_shops").select("id, booking_preferences").eq("id",n).single();if(c||!p)return w.NextResponse.json({error:"Shop not found"},{status:404});let m=p.booking_preferences||{max_bookings_per_day:10,max_bookings_per_slot:1,working_hours:{start:"09:00",end:"17:00"},slot_duration_minutes:30,buffer_time_minutes:15,advance_booking_days:30,same_day_booking_allowed:!0,auto_confirm:!1,require_phone:!1},h=new Date().toISOString().split("T")[0];if(r===h&&!m.same_day_booking_allowed)return w.NextResponse.json({error:"Same-day bookings are not allowed. Please book for a future date."},{status:400});let g=new Date(r),f=new Date;if(f.setDate(f.getDate()+(m.advance_booking_days||30)),g>f)return w.NextResponse.json({error:`Bookings can only be made up to ${m.advance_booking_days} days in advance.`},{status:400});let[_,b]=[m.working_hours?.start||"09:00",m.working_hours?.end||"17:00"];if(a<_||a>=b)return w.NextResponse.json({error:`Bookings are only available between ${_} and ${b}.`},{status:400});let{data:v,error:E}=await t.from("bookings").select("id").eq("shop_id",n).eq("appointment_date",r).in("status",["pending","confirmed"]);if(E&&console.error("Error checking day bookings:",E),(v?.length||0)>=(m.max_bookings_per_day||10)){let{data:e}=await t.from("bookings").select("appointment_date").eq("shop_id",n).gte("appointment_date",r).in("status",["pending","confirmed"]).order("appointment_date",{ascending:!0}).limit(10),o=new Set(e?.map(e=>e.appointment_date)||[]),a=[],i=new Date(r);for(let e=0;e<7&&a.length<3;e++){i.setDate(i.getDate()+1);let e=i.toISOString().split("T")[0];o.has(e)||a.push(e)}return w.NextResponse.json({error:`This shop has reached its daily booking limit (${m.max_bookings_per_day} bookings/day).`,alternativeDates:a.length>0?a:void 0},{status:400})}let{data:N,error:C}=await t.from("bookings").select("id, appointment_time").eq("shop_id",n).eq("appointment_date",r).in("status",["pending","confirmed"]);if(C&&console.error("Error checking slot bookings:",C),(N?.filter(e=>e.appointment_time===a).length||0)>=(m.max_bookings_per_slot||1)){let e=x(_,b,m.slot_duration_minutes||30),t=N?.map(e=>e.appointment_time)||[],n=y(a,t,e,m.buffer_time_minutes||15);return w.NextResponse.json({error:"This time slot is already fully booked.",alternativeTimes:n.length>0?n:void 0},{status:400})}if(m.require_phone&&!d)return w.NextResponse.json({error:"Phone number is required for booking with this shop."},{status:400});let{data:S}=await t.from("bookings").select("id, appointment_time").eq("shop_id",n).eq("appointment_date",r).eq("appointment_time",a).in("status",["pending","confirmed"]);if((S?.length||0)>=(m.max_bookings_per_slot||1)){let e=x(_,b,m.slot_duration_minutes||30),t=S?.map(e=>e.appointment_time)||[],n=y(a,t,e,m.buffer_time_minutes||15);return w.NextResponse.json({error:"This time slot was just booked by someone else. Please select another time.",alternativeTimes:n.length>0?n:void 0},{status:409})}let{data:T}=await t.from("repair_shops").select("name, email, phone, address").eq("id",n).single(),q=m.auto_confirm?"confirmed":"pending",{data:A,error:P}=await t.from("bookings").insert({shop_id:n,diagnosis_id:o||null,user_id:u?.id||null,appointment_date:r,appointment_time:a,notes:i,user_name:s,user_email:l,user_phone:d,status:q}).select().single();if(P)throw console.error("Error creating booking:",P),P;return(0,k.sendBookingConfirmationEmail)({bookingId:A.id,userName:s,userEmail:l,shopName:T?.name||"Repair Shop",shopEmail:T?.email,shopAddress:T?.address,shopPhone:T?.phone,appointmentDate:r,appointmentTime:a,status:q,notes:i||null}).catch(e=>{console.error("Failed to send booking email:",e)}),w.NextResponse.json({booking:A,message:"confirmed"===q?"Booking confirmed automatically based on shop preferences.":"Booking created successfully. Waiting for shop confirmation."},{status:201})}catch(e){return console.error("Error creating booking:",e),w.NextResponse.json({error:"Failed to create booking"},{status:500})}}e.s(["GET",()=>v,"POST",()=>E],30841);var N=e.i(30841);let C=new t.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/bookings/route",pathname:"/api/bookings",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/bookings/route.ts",nextConfigOutput:"",userland:N}),{workAsyncStorage:S,workUnitAsyncStorage:T,serverHooks:q}=C;function A(){return(0,o.patchFetch)({workAsyncStorage:S,workUnitAsyncStorage:T})}async function P(e,t,o){C.isDev&&(0,r.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let R="/api/bookings/route";R=R.replace(/\/index$/,"")||"/";let w=await C.prepare(e,t,{srcPage:R,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==o.waitUntil||o.waitUntil.call(o,Promise.resolve()),null;let{buildId:k,params:v,nextConfig:x,parsedUrl:y,isDraftMode:E,prerenderManifest:N,routerServerContext:S,isOnDemandRevalidate:T,revalidateOnlyGenerated:q,resolvedPathname:A,clientReferenceManifest:P,serverActionsManifest:O}=w,D=(0,l.normalizeAppPath)(R),j=!!(N.dynamicRoutes[D]||N.routes[A]),M=async()=>((null==S?void 0:S.render404)?await S.render404(e,t,y,!1):t.end("This page could not be found"),null);if(j&&!E){let e=!!N.routes[A],t=N.dynamicRoutes[D];if(t&&!1===t.fallback&&!e){if(x.experimental.adapterPath)return await M();throw new _.NoFallbackError}}let I=null;!j||C.isDev||E||(I="/index"===(I=A)?"/":I);let U=!0===C.isDev||!j,H=j&&!U;O&&P&&(0,i.setReferenceManifestsSingleton)({page:R,clientReferenceManifest:P,serverActionsManifest:O,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:O})});let $=e.method||"GET",F=(0,a.getTracer)(),B=F.getActiveScopeSpan(),K={params:v,prerenderManifest:N,renderOpts:{experimental:{authInterrupts:!!x.experimental.authInterrupts},cacheComponents:!!x.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,r.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:x.cacheLife,waitUntil:o.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,n,o)=>C.onRequestError(e,t,o,S)},sharedContext:{buildId:k}},L=new d.NodeNextRequest(e),G=new d.NodeNextResponse(t),V=u.NextRequestAdapter.fromNodeNextRequest(L,(0,u.signalFromNodeResponse)(t));try{let i=async e=>C.handle(V,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let n=F.getRootSpanAttributes();if(!n)return;if(n.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${n.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let o=n.get("next.route");if(o){let t=`${$} ${o}`;e.setAttributes({"next.route":o,"http.route":o,"next.span_name":t}),e.updateName(t)}else e.updateName(`${$} ${R}`)}),s=!!(0,r.getRequestMeta)(e,"minimalMode"),l=async r=>{var a,l;let d=async({previousCacheEntry:n})=>{try{if(!s&&T&&q&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await i(r);e.fetchMetrics=K.renderOpts.fetchMetrics;let l=K.renderOpts.pendingWaitUntil;l&&o.waitUntil&&(o.waitUntil(l),l=void 0);let d=K.renderOpts.collectedTags;if(!j)return await (0,m.sendResponse)(L,G,a,K.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(a.headers);d&&(t[f.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let n=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,o=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:b.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:n,expire:o}}}}catch(t){throw(null==n?void 0:n.isStale)&&await C.onRequestError(e,t,{routerKind:"App Router",routePath:R,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:T})},S),t}},u=await C.handleResponse({req:e,nextConfig:x,cacheKey:I,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:N,isRoutePPREnabled:!1,isOnDemandRevalidate:T,revalidateOnlyGenerated:q,responseGenerator:d,waitUntil:o.waitUntil,isMinimalMode:s});if(!j)return null;if((null==u||null==(a=u.value)?void 0:a.kind)!==b.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",T?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),E&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,h.fromNodeOutgoingHttpHeaders)(u.value.headers);return s&&j||p.delete(f.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,g.getCacheControlHeader)(u.cacheControl)),await (0,m.sendResponse)(L,G,new Response(u.value.body,{headers:p,status:u.value.status||200})),null};B?await l(B):await F.withPropagatedContext(e.headers,()=>F.trace(p.BaseServerSpan.handleRequest,{spanName:`${$} ${R}`,kind:a.SpanKind.SERVER,attributes:{"http.method":$,"http.target":e.url}},l))}catch(t){if(t instanceof _.NoFallbackError||await C.onRequestError(e,t,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:T})}),j)throw t;return await (0,m.sendResponse)(L,G,new Response(null,{status:500})),null}}e.s(["handler",()=>P,"patchFetch",()=>A,"routeModule",()=>C,"serverHooks",()=>q,"workAsyncStorage",()=>S,"workUnitAsyncStorage",()=>T],28910)}];

//# sourceMappingURL=0439a_next_dist_esm_build_templates_app-route_755fdf39.js.map
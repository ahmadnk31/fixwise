module.exports=[28910,e=>{"use strict";var t=e.i(11432),n=e.i(86130),a=e.i(93330),o=e.i(21955),r=e.i(99782),i=e.i(3086),s=e.i(31248),l=e.i(88336),d=e.i(84027),p=e.i(85624),u=e.i(99936),c=e.i(19025),m=e.i(44236),h=e.i(60975),g=e.i(27223),f=e.i(51941),_=e.i(93695);e.i(43985);var b=e.i(35005),R=e.i(89660),w=e.i(19842),k=e.i(133);async function v(e){try{let t=await (0,R.createServerClient)(),n=e.nextUrl.searchParams,a=n.get("shop_id"),o=n.get("user_id"),r=t.from("bookings").select("*").order("appointment_date",{ascending:!0}).order("appointment_time",{ascending:!0});a&&(r=r.eq("shop_id",a)),o&&(r=r.eq("user_id",o));let{data:i,error:s}=await r;if(s)throw s;return w.NextResponse.json({bookings:i})}catch(e){return console.error("Error fetching bookings:",e),w.NextResponse.json({error:"Failed to fetch bookings"},{status:500})}}function y(e,t,n){let a=[],[o,r]=e.split(":").map(Number),[i,s]=t.split(":").map(Number),l=o,d=r;for(;l<i||l===i&&d<s;)a.push(`${l.toString().padStart(2,"0")}:${d.toString().padStart(2,"0")}`),(d+=n)>=60&&(d=0,l++);return a}function x(e,t,n,a){let o=[],[r,i]=e.split(":").map(Number),s=60*r+i;for(let e of n){if(t.includes(e))continue;let[n,r]=e.split(":").map(Number),i=Math.abs(60*n+r-s);i>=a&&i<=120&&o.push(e)}return o.sort((e,t)=>{let[n,a]=e.split(":").map(Number),[o,r]=t.split(":").map(Number);return Math.abs(60*n+a-s)-Math.abs(60*o+r-s)}).slice(0,3)}async function E(e){try{let t=await (0,R.createServerClient)(),{shop_id:n,diagnosis_id:a,appointment_date:o,appointment_time:r,notes:i,user_name:s,user_email:l,user_phone:d}=await e.json();if(!n||!o||!r||!s||!l)return w.NextResponse.json({error:"Missing required fields"},{status:400});let{data:{user:p}}=await t.auth.getUser();if(p?.id){let{data:e}=await t.from("bookings").select("id, appointment_date, appointment_time, shop_id").eq("user_id",p.id).eq("appointment_date",o).eq("appointment_time",r).in("status",["pending","confirmed"]).maybeSingle();if(e)return w.NextResponse.json({error:"You already have an appointment at this time slot. Please choose a different time."},{status:409})}if(!p?.id){let{data:e}=await t.from("bookings").select("id, appointment_date, appointment_time").eq("user_email",l).eq("appointment_date",o).eq("appointment_time",r).in("status",["pending","confirmed"]).maybeSingle();if(e)return w.NextResponse.json({error:"You already have an appointment at this time slot. Please choose a different time."},{status:409})}let{data:u,error:c}=await t.from("repair_shops").select("id, booking_preferences").eq("id",n).single();if(c||!u)return w.NextResponse.json({error:"Shop not found"},{status:404});let m=u.booking_preferences||{max_bookings_per_day:10,max_bookings_per_slot:1,working_hours:{start:"09:00",end:"17:00"},slot_duration_minutes:30,buffer_time_minutes:15,advance_booking_days:30,same_day_booking_allowed:!0,auto_confirm:!1,require_phone:!1},h=new Date().toISOString().split("T")[0];if(o===h&&!m.same_day_booking_allowed)return w.NextResponse.json({error:"Same-day bookings are not allowed. Please book for a future date."},{status:400});let g=new Date(o),f=new Date;if(f.setDate(f.getDate()+(m.advance_booking_days||30)),g>f)return w.NextResponse.json({error:`Bookings can only be made up to ${m.advance_booking_days} days in advance.`},{status:400});let[_,b]=[m.working_hours?.start||"09:00",m.working_hours?.end||"17:00"];if(r<_||r>=b)return w.NextResponse.json({error:`Bookings are only available between ${_} and ${b}.`},{status:400});let{data:v,error:E}=await t.from("bookings").select("id").eq("shop_id",n).eq("appointment_date",o).in("status",["pending","confirmed"]);if(E&&console.error("Error checking day bookings:",E),(v?.length||0)>=(m.max_bookings_per_day||10)){let{data:e}=await t.from("bookings").select("appointment_date").eq("shop_id",n).gte("appointment_date",o).in("status",["pending","confirmed"]).order("appointment_date",{ascending:!0}).limit(10),a=new Set(e?.map(e=>e.appointment_date)||[]),r=[],i=new Date(o);for(let e=0;e<7&&r.length<3;e++){i.setDate(i.getDate()+1);let e=i.toISOString().split("T")[0];a.has(e)||r.push(e)}return w.NextResponse.json({error:`This shop has reached its daily booking limit (${m.max_bookings_per_day} bookings/day).`,alternativeDates:r.length>0?r:void 0},{status:400})}let{data:N,error:C}=await t.from("bookings").select("id, appointment_time").eq("shop_id",n).eq("appointment_date",o).in("status",["pending","confirmed"]);if(C&&console.error("Error checking slot bookings:",C),(N?.filter(e=>e.appointment_time===r).length||0)>=(m.max_bookings_per_slot||1)){let e=y(_,b,m.slot_duration_minutes||30),t=N?.map(e=>e.appointment_time)||[],n=x(r,t,e,m.buffer_time_minutes||15);return w.NextResponse.json({error:"This time slot is already fully booked.",alternativeTimes:n.length>0?n:void 0},{status:400})}if(m.require_phone&&!d)return w.NextResponse.json({error:"Phone number is required for booking with this shop."},{status:400});let{data:S}=await t.from("bookings").select("id, appointment_time").eq("shop_id",n).eq("appointment_date",o).eq("appointment_time",r).in("status",["pending","confirmed"]);if((S?.length||0)>=(m.max_bookings_per_slot||1)){let e=y(_,b,m.slot_duration_minutes||30),t=S?.map(e=>e.appointment_time)||[],n=x(r,t,e,m.buffer_time_minutes||15);return w.NextResponse.json({error:"This time slot was just booked by someone else. Please select another time.",alternativeTimes:n.length>0?n:void 0},{status:409})}let{data:q}=await t.from("repair_shops").select("name, email, phone, address").eq("id",n).single(),T=m.auto_confirm?"confirmed":"pending",{data:P,error:A}=await t.from("bookings").insert({shop_id:n,diagnosis_id:a||null,user_id:p?.id||null,appointment_date:o,appointment_time:r,notes:i,user_name:s,user_email:l,user_phone:d,status:T}).select().single();if(A)throw console.error("Error creating booking:",A),A;return(0,k.sendBookingConfirmationEmail)({bookingId:P.id,userName:s,userEmail:l,shopName:q?.name||"Repair Shop",shopEmail:q?.email,shopAddress:q?.address,shopPhone:q?.phone,appointmentDate:o,appointmentTime:r,status:T,notes:i||null}).catch(e=>{console.error("Failed to send booking email:",e)}),w.NextResponse.json({booking:P,message:"confirmed"===T?"Booking confirmed automatically based on shop preferences.":"Booking created successfully. Waiting for shop confirmation."},{status:201})}catch(e){return console.error("Error creating booking:",e),w.NextResponse.json({error:"Failed to create booking"},{status:500})}}e.s(["GET",()=>v,"POST",()=>E],30841);var N=e.i(30841);let C=new t.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/bookings/route",pathname:"/api/bookings",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/bookings/route.ts",nextConfigOutput:"",userland:N}),{workAsyncStorage:S,workUnitAsyncStorage:q,serverHooks:T}=C;function P(){return(0,a.patchFetch)({workAsyncStorage:S,workUnitAsyncStorage:q})}async function A(e,t,a){C.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let R="/api/bookings/route";R=R.replace(/\/index$/,"")||"/";let w=await C.prepare(e,t,{srcPage:R,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:k,params:v,nextConfig:y,parsedUrl:x,isDraftMode:E,prerenderManifest:N,routerServerContext:S,isOnDemandRevalidate:q,revalidateOnlyGenerated:T,resolvedPathname:P,clientReferenceManifest:A,serverActionsManifest:j}=w,O=(0,l.normalizeAppPath)(R),D=!!(N.dynamicRoutes[O]||N.routes[P]),M=async()=>((null==S?void 0:S.render404)?await S.render404(e,t,x,!1):t.end("This page could not be found"),null);if(D&&!E){let e=!!N.routes[P],t=N.dynamicRoutes[O];if(t&&!1===t.fallback&&!e){if(y.experimental.adapterPath)return await M();throw new _.NoFallbackError}}let I=null;!D||C.isDev||E||(I="/index"===(I=P)?"/":I);let U=!0===C.isDev||!D,H=D&&!U;j&&A&&(0,i.setReferenceManifestsSingleton)({page:R,clientReferenceManifest:A,serverActionsManifest:j,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:j})});let $=e.method||"GET",F=(0,r.getTracer)(),B=F.getActiveScopeSpan(),K={params:v,prerenderManifest:N,renderOpts:{experimental:{authInterrupts:!!y.experimental.authInterrupts},cacheComponents:!!y.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:y.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,n,a)=>C.onRequestError(e,t,a,S)},sharedContext:{buildId:k}},L=new d.NodeNextRequest(e),G=new d.NodeNextResponse(t),V=p.NextRequestAdapter.fromNodeNextRequest(L,(0,p.signalFromNodeResponse)(t));try{let i=async e=>C.handle(V,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let n=F.getRootSpanAttributes();if(!n)return;if(n.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${n.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=n.get("next.route");if(a){let t=`${$} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${$} ${R}`)}),s=!!(0,o.getRequestMeta)(e,"minimalMode"),l=async o=>{var r,l;let d=async({previousCacheEntry:n})=>{try{if(!s&&q&&T&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await i(o);e.fetchMetrics=K.renderOpts.fetchMetrics;let l=K.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let d=K.renderOpts.collectedTags;if(!D)return await (0,m.sendResponse)(L,G,r,K.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(r.headers);d&&(t[f.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let n=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,a=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:b.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:n,expire:a}}}}catch(t){throw(null==n?void 0:n.isStale)&&await C.onRequestError(e,t,{routerKind:"App Router",routePath:R,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:q})},S),t}},p=await C.handleResponse({req:e,nextConfig:y,cacheKey:I,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:N,isRoutePPREnabled:!1,isOnDemandRevalidate:q,revalidateOnlyGenerated:T,responseGenerator:d,waitUntil:a.waitUntil,isMinimalMode:s});if(!D)return null;if((null==p||null==(r=p.value)?void 0:r.kind)!==b.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==p||null==(l=p.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",q?"REVALIDATED":p.isMiss?"MISS":p.isStale?"STALE":"HIT"),E&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,h.fromNodeOutgoingHttpHeaders)(p.value.headers);return s&&D||u.delete(f.NEXT_CACHE_TAGS_HEADER),!p.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,g.getCacheControlHeader)(p.cacheControl)),await (0,m.sendResponse)(L,G,new Response(p.value.body,{headers:u,status:p.value.status||200})),null};B?await l(B):await F.withPropagatedContext(e.headers,()=>F.trace(u.BaseServerSpan.handleRequest,{spanName:`${$} ${R}`,kind:r.SpanKind.SERVER,attributes:{"http.method":$,"http.target":e.url}},l))}catch(t){if(t instanceof _.NoFallbackError||await C.onRequestError(e,t,{routerKind:"App Router",routePath:O,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:q})}),D)throw t;return await (0,m.sendResponse)(L,G,new Response(null,{status:500})),null}}e.s(["handler",()=>A,"patchFetch",()=>P,"routeModule",()=>C,"serverHooks",()=>T,"workAsyncStorage",()=>S,"workUnitAsyncStorage",()=>q],28910)}];

//# sourceMappingURL=0439a_next_dist_esm_build_templates_app-route_755fdf39.js.map